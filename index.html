<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Driver ShopeeFood</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button, select { margin: 5px; padding: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2>Driver ShopeeFood Bandar Lampung</h2>

<!-- ================= AUTH ================= -->
<div id="auth">
  <h3>Register</h3>
  <input id="r_nama" placeholder="Nama">
  <input id="r_email" placeholder="Email">
  <input id="r_nohp" placeholder="No HP">
  <input id="r_password" type="password" placeholder="Password">
  <button onclick="register()">Register</button>

  <h3>Login</h3>
  <input id="l_email" placeholder="Email">
  <input id="l_password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- ================= CRUD ================= -->
<div id="crud" class="hidden">

  <button onclick="logout()">Logout</button>

  <h3>Tambah / Update Driver</h3>
  <input type="hidden" id="id">
  <input id="nama" placeholder="Nama">
  <input id="email" placeholder="Email">
  <input id="no_hp" placeholder="No HP">
  <input id="alamat" placeholder="Alamat">
  <input id="kendaraan" placeholder="Kendaraan">
  <select id="status">
    <option value="aktif">Aktif</option>
    <option value="nonaktif">Nonaktif</option>
  </select>
  <button onclick="saveDriver()">Simpan</button>

  <h3>Data Driver</h3>
  <table>
    <thead>
      <tr>
        <th>ID</th><th>Nama</th><th>Email</th><th>No HP</th>
        <th>Alamat</th><th>Kendaraan</th><th>Status</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody id="drivers"></tbody>
  </table>
</div>

<script>
// ================= CONFIG =================
const AUTH_API   = "https://driver-auth.vercel.app";
const DRIVER_API = "https://driver-service-kappa.vercel.app/drivers";

let token = localStorage.getItem("token");

// ================= AUTH =================
async function register() {
  const res = await fetch(`${AUTH_API}/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      nama: r_nama.value,
      email: r_email.value,
      no_hp: r_nohp.value,
      password: r_password.value
    })
  });

  const data = await res.json();
  alert(data.message || "Register berhasil");
}

async function login() {
  const res = await fetch(`${AUTH_API}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: l_email.value,
      password: l_password.value
    })
  });

  const data = await res.json();
  if (!data.token) {
    alert(data.message || "Login gagal");
    return;
  }

  token = data.token;
  localStorage.setItem("token", token);

  auth.classList.add("hidden");
  crud.classList.remove("hidden");

  loadDrivers();
}

function logout() {
  localStorage.removeItem("token");
  location.reload();
}

// ================= CRUD =================
async function loadDrivers() {
  const res = await fetch(DRIVER_API, {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  });

  const data = await res.json();
  const rows = data.drivers || [];

  drivers.innerHTML = "";

  if (rows.length === 0) {
    drivers.innerHTML = `<tr><td colspan="8">Data kosong</td></tr>`;
    return;
  }

  rows.forEach(d => {
    drivers.innerHTML += `
      <tr>
        <td>${d.id}</td>
        <td>${d.nama}</td>
        <td>${d.email}</td>
        <td>${d.no_hp}</td>
        <td>${d.alamat || ""}</td>
        <td>${d.kendaraan || ""}</td>
        <td>${d.status}</td>
        <td>
          <button onclick='edit(${JSON.stringify(d)})'>Edit</button>
          <button onclick='hapus(${d.id})'>Hapus</button>
        </td>
      </tr>
    `;
  });
}

async function saveDriver() {
  const id = document.getElementById("id").value;

  const payload = {
    nama: nama.value,
    email: email.value,
    no_hp: no_hp.value,
    alamat: alamat.value,
    kendaraan: kendaraan.value,
    status: status.value
  };

  const method = id ? "PUT" : "POST";
  const url = id ? `${DRIVER_API}/${id}` : DRIVER_API;

  const res = await fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  alert(data.message || "Berhasil");

  reset();
  loadDrivers();
}

function edit(d) {
  id.value = d.id;
  nama.value = d.nama;
  email.value = d.email;
  no_hp.value = d.no_hp;
  alamat.value = d.alamat || "";
  kendaraan.value = d.kendaraan || "";
  status.value = d.status;
}

async function hapus(id) {
  if (!confirm("Hapus driver?")) return;

  await fetch(`${DRIVER_API}/${id}`, {
    method: "DELETE",
    headers: {
      "Authorization": `Bearer ${token}`
    }
  });

  loadDrivers();
}

function reset() {
  id.value = "";
  nama.value = "";
  email.value = "";
  no_hp.value = "";
  alamat.value = "";
  kendaraan.value = "";
}

// ================= AUTO LOGIN =================
if (token) {
  auth.classList.add("hidden");
  crud.classList.remove("hidden");
  loadDrivers();
}
</script>

</body>
</html>
